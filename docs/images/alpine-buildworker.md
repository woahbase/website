---
description: MultiArch Alpine Linux + S6 + Python3 + Buildbot (Worker)
svcname: buildworker
ghrepo: alpine-buildbot
tags:
  - python
  - service
wb_extra_args: ROLE=worker
---

{% import "macros.md" as m with context %}
{% include "shields.md" %}

This [image][155] serves as the base container for running
a [Buildbot][1] **worker** instance to execute build-steps as
defined in the master. Also, checkout the {{
m.myimage('alpine-buildmaster') }} image for running a master
service.

{{ m.srcimage('alpine-python3') }} with the {{
m.pypipkg('buildbot-worker') }} package(s) installed in it.

{% include "pull-image.md" %}

---
#### Run
---

Running the container starts the service.

``` sh
docker run --rm \
  --name docker_buildworker \
  -e BUILDBOT_MASTERADDRESS=your.buildmaster.local`#(1)` \
  -e BUILDBOT_WORKERNAME=buildbot-worker`#(2)` \
  -e BUILDBOT_WORKERPASS=insecurebydefault`#(3)` \
  -v $PWD/buildworker`#(4)`:/home/alpine/buildbot \
woahbase/alpine-buildworker
```

1. (Required) Address of the master node. (Port defaults to 9989)
2. (Required) Name of the worker node.
3. (Required) Password of the worker node.
4. (Optional) Path to your buildbot worker configurations root directory, if you need it to persist.

--8<-- "multiarch.md"

---
##### Configuration
---

We can customize the runtime behaviour of the container with the
following environment variables.

| ENV Vars                      | Default                                             | Description
| :---                          | :---                                                | :---
| BUILDBOT_HOME                 | /home/alpine/buildbot                               | Default root directory for buildbot configurations.
| BUILDBOT_PROJECTNAME          | buildbot                                            | Project name that is prepended to the worker name, e.g. default is `buildbot`-worker.
| BUILDBOT_SETUP_ARGS           | --force --log-count=2 --log-size=5000 --relocatable | These arguments are passed to setup the worker.
| BUILDBOT_SKIP_SETUP           | unset                                               | If `true`, skips worker setup tasks, useful when your already have your configurations setup, or would like to do it manually.
| BUILDBOT_USE_CUSTOM_TACFILE   | unset                                               | Whether to use custom tacfile provided in the image that logs to `stdout` by default, set to a non-empty string (e.g `1`) to enable, or use the one generated by package.
| BUILDBOT_CUSTOM_TACFILE       | {{ m.ghfilelink('root/defaults/worker.tac', ghrepo=ghrepo, title='/defaults/worker.tac') }} | Customizable path to tacfile provided in the image.
| BUILDBOT_BASEDIR              | unset                                               | Used in the custom tacfile to determine where builder files are stored, defaults to "." when unset (current directory where `buildbot.tac` exists), or any other directory (must exist).
| BUILDBOT_LOGDEST              | stdout                                              | Used in the custom tacfile to determine where logs are sent, can be either of `stdout` (default), `syslog`, or `file`.
| BUILDBOT_LOGROTATE_LENGTH     | 5000                                                | Used in the custom tacfile to determine maximum lines-in-logfile before it is rotated.
| BUILDBOT_LOGROTATE_MAXFILES   | 2                                                   | Used in the custom tacfile to determine maximum rotated logfiles that are kept in storage.
| BUILDBOT_MASTERADDRESS        | localhost                                           | Address of the master node, **required** for the worker to connect.
| BUILDBOT_MASTERPORT           | 9989                                                | Port of the master node.
| BUILDBOT_PROTOCOL             | pb                                                  | Protocol used by the worker when connecting to the master.
| BUILDBOT_WORKERNAME           | ${BUILDBOT_PROJECTNAME}-worker                      | Name of the worker, **required** for the worker to connect.
| BUILDBOT_WORKERPASS           | insecurebydefault                                   | Password of the worker, **required** for the worker to connect.
| BUILDBOT_WORKER_KEEPALIVE     | 180                                                 | Check-in with master periodically with this interval.
| BUILDBOT_WORKER_MAXDELAY      | 180                                                 | If master is lost, worker process exits after this amount of time.
| BUILDBOT_WORKER_MAXRETRIES    | 5                                                   | If master is lost, how many retries till connection failure .
| BUILDBOT_WORKER_USETLS        | 0                                                   | Whether to use TLS for connecting to master, (only when using custom tacfile) requires certificate to be setup on the worker.
| BUILDBOT_WORKERINFO_ADMIN     | docker                                              | Sets worker `info/admin` file.
| BUILDBOT_WORKERINFO_HOST      | ${HOSTNAME}                                         | Sets worker `info/host` file.
| BUILDBOT_WORKERINFO_ACCESSURI | ssh://${HOSTNAME}                                   | Sets worker `info/access_uri` file.
| BUILDBOT_SKIP_CUSTOMIZE       | unset                                               | Skip post-setup customization tasks.
| BUILDBOT_SKIP_PERMFIX         | unset                                               | Skip ensuring files in `${BUILDBOT_HOME}` are owned by `${S6_USER}`, enabled by default.
| BUILDBOT_ARGS                 | --nodaemon --no_save                                | Customizable arguments passed to worker service. (Runs as a `twisted` application instead of calling `buildbot-worker` executable)
{% include "envvars/alpine-python3.md" %}
{% include "envvars/alpine-s6.md" %}

--8<-- "check-id.md"

Also,

* The env variable `BUILDBOT_ROLE` determines if you are running
  a master or worker. This also determines what image you'll be
  running when used with the `makefile`. This is baked into the
  image so does not need to be changes unless you know what you're
  doing.

* Setup tasks are only run when the `buildbot.tac` file does not
  exist or `BUILDBOT_SKIP_SETUP` is not set. Same goes for
  arguments / environment variables specific to setup, they are
  not needed anymore after setup is complete.

* {{ m.customscript('p22-buildbot-customize', ghrepo=ghrepo) }}

* The service **does not** run `buildbot-worker`, instead calls
  `twistd` directly, pass `BUILDBOT_ARGS` accordingly.

* Mount the configurations at the `BUILDBOT_HOME` directory inside
  the container, by default it is `/home/alpine/buildbot`. This is
  optional for workers, however make sure you have enough cpu
  power and memory for the workers to do the heavy lifting if
  required.

[1]: https://buildbot.net/
[2]: https://docs.buildbot.net/current/index.html

{% include "all-include.md" %}
