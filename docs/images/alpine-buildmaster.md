---
description: MultiArch Alpine Linux + S6 + Python3 + Buildbot (Master)
svcname: buildmaster
ghrepo: alpine-buildbot
has_services:
  - compose
  - nomad
has_proxies:
  - nginx
tags:
  - python
  - service
wb_extra_args: ROLE=master
---

{% import "macros.md" as m with context %}
{% include "shields.md" %}

This [image][155] serves as the base container for running
a [Buildbot][1] **master** instance to build applications, run
periodic tasks, and other automations. Checkout their [docs][2]
for configurations or task definitions. Also, checkout the {{
m.myimage('alpine-buildworker') }} image for running
a standalone worker as a service.

{{ m.srcimage('alpine-python3') }} with the {{
m.pypipkg('buildbot') }} package(s) installed in it.

{% include "pull-image.md" %}

---
Run
---

Running the container starts the service.

``` sh
docker run --rm \
  --name docker_buildmaster \
  -c 256 -m 256m \
  -p 8010:8010 \
  -p 9989:9989 \
  -p 9990:9990 \
  -p 9991:9991 \
  -v $PWD/buildmaster`#(1)`:/home/alpine/buildbot \
woahbase/alpine-buildmaster
```

1. (Required) Path to your buildbot master configurations root directory.

--8<-- "multiarch.md"

---
##### Configuration
---

We can customize the runtime behaviour of the container with the
following environment variables.

| ENV Vars                    | Default                                             | Description
| :---                        | :---                                                | :---
| BUILDBOT_HOME               | /home/alpine/buildbot                               | Default root directory for buildbot configurations.
| BUILDBOT_PROJECTNAME        | buildbot                                            | Project name that is prepended to the master name, e.g. default is `buildbot`-master.
| BUILDBOT_SETUP_ARGS         | --force --log-count=2 --log-size=5000 --relocatable | These arguments are passed to setup the master.
| BUILDBOT_SKIP_SETUP         | unset                                               | Skips master setup tasks, useful when your already have your configurations setup, or would like to do it manually.
| BUILDBOT_MASTERNAME         | ${BUILDBOT_PROJECTNAME}-master                      | Name of the service, defaults to `projectname-rolename`.
| BUILDBOT_MASTERCFG          | ${BUILDBOT_MASTERNAME}/master.cfg.sample            | Path to custom configuration file that is copied into place as `master.cfg` before starting service.
| BUILDBOT_USE_CUSTOM_TACFILE | unset                                               | Whether to use custom tacfile provided in the image that logs to `stdout` by default, set to a non-empty string (e.g `1`) to enable, or use the one generated by package.
| BUILDBOT_CUSTOM_TACFILE     | {{ m.ghfilelink('root/defaults/master.tac', ghrepo=ghrepo, title='/defaults/master.tac') }} | Customizable path to tacfile provided in the image.
| BUILDBOT_BASEDIR            | unset                                               | Used in the custom tacfile to determine where builder files are stored, defaults to "." when unset (current directory where `buildbot.tac` exists), or any other directory (must exist).
| BUILDBOT_LOGDEST            | stdout                                              | Used in the custom tacfile to determine where logs are sent, can be either of `stdout` (default), `syslog`, or `file`.
| BUILDBOT_LOGROTATE_LENGTH   | 5000                                                | Used in the custom tacfile to determine maximum lines-in-logfile before it is rotated.
| BUILDBOT_LOGROTATE_MAXFILES | 2                                                   | Used in the custom tacfile to determine maximum rotated logfiles that are kept in storage.
| BUILDBOT_CONFIG_URL         | unset                                               | If set, tries to fetch configuration from remote location. Can be a `tar.gz` file, or a git repository, or a file link to `master.cfg` itself.
| BUILDBOT_CONFIG_DIR         | ${BUILDBOT_HOME}/config                             | Configurations fetched from remote location unpacked in this directory.
| BUILDBOT_CONFIG_TMP         | ${BUILDBOT_HOME}/.tmp                               | Configurations fetched from remote location are temporarily stored in this directory. (Useful if `/tmp` is non-writable or limited space)
| BUILDBOT_CONFIG_CFGFILE     | master.cfg                                          | Customizable path to master.cfg as relative to downloaded configurations. Default expects at the root of directory, if it exists, it is copied into place as `master.cfg` before starting service.
| BUILDBOT_CONFIG_TACFILE     | buildbot.tac                                        | Customizable path to buildbot.tac as relative to downloaded configurations. Default expects at the root of directory, if it exists, it is copied into place as `buildbot.tac` before starting service.
| BUILDBOT_SKIP_CHECKCONFIG   | unset                                               | If `true`. skips checking configurations before starting service.
| BUILDBOT_UPGRADE_MASTER     | unset                                               | If `true`, upgrades master database before starting service.
| BUILDBOT_CLEANUP_DB         | unset                                               | If `true`, runs cleanup tasks on master database before starting service.
| BUILDBOT_WORKERNAME         | ${BUILDBOT_PROJECTNAME}-worker                      | Name of the default worker updated in `master.cfg`. (Only when using the sample configurations)
| BUILDBOT_WORKERPASS         | insecurebydefault                                   | Password of the default worker updated in `master.cfg`. (Only when using the sample configurations)
| BUILDBOT_SKIP_CUSTOMIZE     | unset                                               | Skip post-setup customization tasks.
| BUILDBOT_SKIP_PERMFIX       | unset                                               | Skip ensuring files in `${BUILDBOT_HOME}` are owned by `${S6_USER}`, enabled by default.
| BUILDBOT_ARGS               | --nodaemon --no_save                                | Customizable arguments passed to master service. (Runs as a `twisted` application instead of calling `buildbot` executable)
{% include "envvars/alpine-python3.md" %}
{% include "envvars/alpine-s6.md" %}

--8<-- "check-id.md"

Also,

* The env variable `BUILDBOT_ROLE` determines if you are running
  a master or worker. This also determines what image you'll be
  running when used with the `makefile`. It is baked into the
  image so does not need to be changed unless you know what you're
  doing.

* Setup tasks are only run when the `buildbot.tac` file does not
  exist or `BUILDBOT_SKIP_SETUP` is not set. Same goes for
  arguments / environment variables specific to setup, they are
  not needed anymore after setup is complete.

* However, if `BUILDBOT_MASTERCFG` is defined, it will always be
  copied into project before starting the service. This is useful
  for large projects that maintain the configurations separately
  from master configurations.

* {{ m.customscript('p22-buildbot-customize', ghrepo=ghrepo) }}

* The service **does not** run `buildbot` for master, instead calls
  `twistd` directly, pass `BUILDBOT_ARGS` accordingly.

* For the master node, mount the configurations at the
  `BUILDBOT_HOME` directory inside the container, by default it is
  `/home/alpine/buildbot`.

[1]: https://buildbot.net/
[2]: https://docs.buildbot.net/current/index.html

{% include "all-include.md" %}
